# Backend Development Plan ‚Äî Crimson Gecko Bounce

## 1Ô∏è‚É£ Executive Summary
This project builds the backend for **Crimson Gecko Bounce**, a character formation platform. We will use **FastAPI (Python 3.13)** and **MongoDB Atlas** to replace the current frontend mock data (`localStorage`) with a persistent, scalable database.

**Key Constraints & Strategy:**
- **Stack:** FastAPI (Async), Motor (MongoDB driver), Pydantic v2.
- **No Docker:** Direct local execution.
- **Workflow:** Dynamic sprints, single `main` branch, manual testing per task.
- **Scope:** strictly limited to features visible in the provided frontend and PRD.

---

## 2Ô∏è‚É£ In-Scope & Success Criteria

### In-Scope Features
- **Auth:** Signup, Login, Logout (JWT).
- **Onboarding:** Character Assessment (Quantitative/Qualitative), Scoring, Profile Generation.
- **Goal Setting:** Select priority virtues, set innovation goals.
- **Engagement:** Log character moments, receive immediate "AI" feedback.
- **Dashboard:** Radar charts, virtue history/trends.
- **Reflection:** Weekly summary generation, calendar pattern insights (simulated/logic-based).
- **Challenges:** Weekly virtue challenges (view/complete).
- **News:** Search/filter character-driven articles.

### Success Criteria
- All frontend components fetch data from `/api/v1/*` instead of `localStorage`.
- All forms (Login, Assessment, Logging) submit successfully to the backend.
- Data persists across browser refreshes (stored in MongoDB Atlas).
- Manual tests pass for every task.

---

## 3Ô∏è‚É£ API Design

**Base Path:** `/api/v1`  
**Format:** JSON  
**Error Wrapper:** `{ "detail": "Error message" }`

| Method | Endpoint | Purpose | Request Body | Response |
| :--- | :--- | :--- | :--- | :--- |
| **GET** | `/healthz` | System health | - | `{ status: "ok", db: "connected" }` |
| **POST** | `/auth/signup` | Register user | `{ email, password, name }` | `{ token, user }` |
| **POST** | `/auth/login` | Login user | `{ email, password }` | `{ token, user }` |
| **POST** | `/assessment` | Submit assessment | `{ answers: { q1: 5, ... } }` | `{ scores: [], profile: "..." }` |
| **GET** | `/assessment` | Get results | - | `{ scores: [], profile: "..." }` |
| **POST** | `/goals` | Set user goals | `{ priorityVirtues: [], ... }` | `{ success: true }` |
| **GET** | `/goals` | Get user goals | - | `{ priorityVirtues: [], ... }` |
| **POST** | `/moments` | Log moment | `{ moment, virtueId }` | `{ id, feedback }` |
| **GET** | `/moments` | Get history | - | `[ { id, moment, feedback, ... } ]` |
| **GET** | `/dashboard/stats` | Radar/Trend data | - | `{ currentScores: [], history: [] }` |
| **GET** | `/reflection/weekly` | Weekly summary | - | `{ summary: "...", insights: [] }` |
| **GET** | `/challenges` | Get challenges | - | `[ { id, title, status } ]` |
| **PATCH** | `/challenges/{id}` | Update status | `{ status }` | `{ success: true }` |
| **GET** | `/news` | Search news | `?q=searchterm` | `[ { title, url, ... } ]` |

---

## 4Ô∏è‚É£ Data Model (MongoDB Atlas)

**Collections:**

1.  **users**
    *   `_id`: ObjectId
    *   `email`: string (unique)
    *   `password_hash`: string
    *   `name`: string
    *   `created_at`: datetime

2.  **assessments**
    *   `user_id`: ObjectId (ref)
    *   `answers`: dict (question_id -> score)
    *   `scores`: list (`{ virtueId: string, score: number }`)
    *   `narrative_profile`: string
    *   `timestamp`: datetime

3.  **goals**
    *   `user_id`: ObjectId (ref)
    *   `priority_virtues`: list[string]
    *   `innovation_goal`: string
    *   `timestamp`: datetime

4.  **moments**
    *   `user_id`: ObjectId (ref)
    *   `content`: string
    *   `virtue_id`: string
    *   `feedback`: string
    *   `timestamp`: datetime

5.  **challenges**
    *   `user_id`: ObjectId (ref)
    *   `title`: string
    *   `virtue_id`: string
    *   `status`: string ("pending" | "completed")
    *   `week_start`: datetime

6.  **articles** (Static or admin-managed)
    *   `title`: string
    *   `description`: string
    *   `url`: string
    *   `virtues`: list[string]
    *   `image_url`: string

---

## 5Ô∏è‚É£ Frontend Audit & Feature Map

| Page/Component | Data Needed | Backend Requirement |
| :--- | :--- | :--- |
| `Index.tsx` | Auth state | `/auth/me` or Check Token |
| `OnboardingPage` | Questions, Submit | `POST /assessment`, `POST /goals` |
| `DashboardPage` | Radar Chart, Stats | `GET /dashboard/stats`, `GET /goals` |
| `CharacterMomentLogger` | Virtues list, Submit | `POST /moments` (Feedback generated by BE) |
| `LoggedMomentsDisplay` | List of moments | `GET /moments` |
| `WeeklyReflectionPage` | Summary, Insights | `GET /reflection/weekly` |
| `WeeklyChallenges` | Challenge list | `GET /challenges`, `PATCH /challenges/{id}` |
| `NewsPage` | Articles list | `GET /news` |

---

## 6Ô∏è‚É£ Configuration & ENV Vars

- `APP_ENV`: "development"
- `PORT`: "8000"
- `MONGODB_URI`: Connection string (Atlas)
- `JWT_SECRET`: Secret key for signing tokens
- `JWT_EXPIRES_IN`: "604800" (7 days)
- `CORS_ORIGINS`: "http://localhost:5173" (Vite default)

---

## 7Ô∏è‚É£ Testing Strategy

- **Level:** Manual UI validation.
- **Process:**
    1.  Start Backend (`uvicorn main:app --reload`).
    2.  Start Frontend (`npm run dev`).
    3.  Perform the "Manual Test Step" listed in the task.
    4.  Verify data persistence (reload page).

---

## üîü Dynamic Sprint Plan & Backlog

### üß± S0: Environment & Foundation

**Objectives:**
- Initialize FastAPI project.
- Connect to MongoDB Atlas.
- Setup CORS and Health check.

**Tasks:**
1.  **Init Project:** Create `backend/` folder, `requirements.txt` (fastapi, uvicorn, motor, pydantic-settings, python-multipart, pyjwt, passlib[argon2]).
    - *Test:* Run `pip install -r requirements.txt` successfully.
2.  **App Skeleton:** Create `main.py` with `FastAPI()` and CORS middleware.
    - *Test:* Access `http://localhost:8000/docs`.
3.  **Database:** Create `config.py` (env vars) and `database.py` (Motor client).
    - *Test:* Backend logs "Connected to MongoDB" on startup.
4.  **Health Check:** Add `GET /healthz` returning `{ status: "ok", db: "connected" }`.
    - *Test Prompt:* "Visit /healthz and confirm DB status is connected."

### üß© S1: Authentication

**Objectives:**
- User registration and login.
- JWT token issuance.

**Tasks:**
1.  **User Model:** Create Pydantic models (UserCreate, UserResponse) and Mongo collection helper.
    - *Test:* N/A (code only).
2.  **Signup Endpoint:** `POST /api/v1/auth/signup`. Hash password, store user.
    - *Test Prompt:* "Use Postman/Curl to sign up a user. Check MongoDB Atlas collection 'users'."
3.  **Login Endpoint:** `POST /api/v1/auth/login`. Verify password, return JWT.
    - *Test Prompt:* "Login with the created user. Decode the returned JWT to verify payload."
4.  **Frontend Auth Wiring:** (Frontend work) Update login form to hit API.
    - *Test Prompt:* "Register via the Frontend UI. You should be redirected to Onboarding."

### üöÄ S2: Assessment & Goals (Onboarding)

**Objectives:**
- Handle assessment submission.
- Calculate scores (simple logic: average of answers).
- Store goals.

**Tasks:**
1.  **Assessment API:** `POST /api/v1/assessment`. Receive answers, calculate scores per virtue (map questions to virtues), generate a simple narrative (template-based), store in DB.
    - *Test Prompt:* "Submit the questionnaire. Check DB for 'assessments' document with calculated scores."
2.  **Goals API:** `POST /api/v1/goals`. Store priority virtues and innovation goal.
    - *Test Prompt:* "Complete the goal setting step. Verify data in 'goals' collection."
3.  **Get Context API:** `GET /api/v1/assessment` and `GET /api/v1/goals` for the dashboard to load.
    - *Test Prompt:* "Reload the dashboard. Ensure radar chart and goals render from DB data."

### üìù S3: Daily Engagement (Moments)

**Objectives:**
- Log character moments.
- Generate "AI" feedback (backend logic).

**Tasks:**
1.  **Moment API:** `POST /api/v1/moments`.
    - Logic: Save moment. Simple rule-based feedback (e.g., "Well done showing [virtue]!").
    - *Test Prompt:* "Log a moment in the UI. Ensure a success toast appears with the feedback."
2.  **History API:** `GET /api/v1/moments`. Return list sorted by date desc.
    - *Test Prompt:* "Check the Dashboard/History tab. The logged moment should appear there."

### üìä S4: Dashboard & Insights

**Objectives:**
- Populate dashboard charts.
- Weekly reflection data.

**Tasks:**
1.  **Dashboard Stats:** `GET /api/v1/dashboard/stats`. Aggregate history to show trends (mock past data if empty).
    - *Test Prompt:* "View the Virtue Trend Chart. It should reflect the data."
2.  **Weekly Reflection:** `GET /api/v1/reflection/weekly`. Generate summary text based on recent moments and goals.
    - *Test Prompt:* "Go to 'Weekly Reflection'. The text should dynamically reference your recent logged virtue."
3.  **Calendar Insights:** `GET /api/v1/calendar/insights`. Return logic-based insights (e.g., "You logged 3 moments this week").
    - *Test Prompt:* "Verify insights section loads."

### üèÜ S5: Challenges & News

**Objectives:**
- Manage weekly challenges.
- Search news.

**Tasks:**
1.  **Challenges API:** `GET /challenges` (generate if missing for week), `PATCH /challenges/{id}` (toggle status).
    - *Test Prompt:* "Click a challenge checkbox. Reload. It should stay checked."
2.  **News API:** `GET /api/v1/news`. Return filtered list of static articles.
    - *Test Prompt:* "Search for 'Courage'. Only relevant articles should appear."